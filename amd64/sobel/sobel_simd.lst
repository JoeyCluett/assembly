     1                                 %line 1+1 sobel_simd/main.asm
     2                                 
     3                                 
     4                                 
     5                                 
     6                                 
     7                                 
     8                                 
     9                                 
    10                                 
    11                                 
    12                                 
    13                                 
    14                                 
    15                                 
    16                                 
    17                                 
    18                                 
    19                                 
    20                                 
    21                                 
    22                                 [extern printf]
    23                                 
    24                                 [global apply_simd_sobel]
    25                                 
    26                                 
    27                                 [section .data]
    28                                 [align 32]
    29 00000000 000000000000F0BF00-     sobelr0: dq -1.0, -2.0, -1.0, 0.0
    30 00000000 000000000000C00000-
    31 00000000 00000000F0BF000000-
    32 00000000 0000000000         
    33                                 [align 32]
    34 00000020 000000000000000000-     sobelr1: dq 0.0, 0.0, 0.0, 0.0
    35 00000020 000000000000000000-
    36 00000020 000000000000000000-
    37 00000020 0000000000         
    38                                 [align 32]
    39 00000040 000000000000F03F00-     sobelr2: dq 1.0, 2.0, 1.0, 0.0
    40 00000040 000000000000400000-
    41 00000040 00000000F03F000000-
    42 00000040 0000000000         
    43                                 
    44                                 [align 32]
    45 00000060 000000000000000000-     sobelr0_shr: dq 0.0, -1.0, -2.0, -1.0
    46 00000060 0000000000F0BF0000-
    47 00000060 0000000000C0000000-
    48 00000060 000000F0BF         
    49                                 [align 32]
    50 00000080 000000000000000000-     sobelr1_shr: dq 0.0, 0.0, 0.0, 0.0
    51 00000080 000000000000000000-
    52 00000080 000000000000000000-
    53 00000080 0000000000         
    54                                 [align 32]
    55 000000A0 000000000000000000-     sobelr2_shr: dq 0.0, 1.0, 2.0, 1.0
    56 000000A0 0000000000F03F0000-
    57 000000A0 000000000040000000-
    58 000000A0 000000F03F         
    59                                 
    60 000000C0 5074723A2025700A00      print_pointer: db "Ptr: %p", 0xA, 0x0
    61                                 
    62                                 [section .text]
    63                                 apply_simd_sobel:
    64                                 
    65 00000000 55                      push rbp
    66 00000001 4889E5                  mov rbp, rsp
    67 00000004 4883EC48                sub rsp, 72
    68                                 
    69                                 
    70                                 
    71                                 
    72                                 
    73                                 
    74                                 
    75                                 
    76                                 
    77                                 
    78 00000008 4883FA03                cmp rdx, 3
    79 0000000C 0F8C24010000            jl clean_and_return
    80 00000012 4883F903                cmp rcx, 3
    81 00000016 0F8C1A010000            jl clean_and_return
    82                                 
    83                                 
    84                                 
    85                                 
    86                                 
    87                                 
    88                                 
    89                                 
    90 0000001C 4883EA02                sub rdx, 2
    91 00000020 4883E902                sub rcx, 2
    92 00000024 48C1E103                shl rcx, 3
    93                                 
    94                                 
    95 00000028 4801CE                  add rsi, rcx
    96 0000002B 4883C618                add rsi, 24
    97                                 
    98 0000002F 4D31C0                  xor r8, r8
    99                                 
   100                                 
   101                                 
   102 00000032 C5FD280425[00000000]      vmovapd ymm0, [sobelr0]
   103 0000003B C5FD280C25[00000000]      vmovapd ymm1, [sobelr1]
   104 00000044 C5FD281425[00000000]      vmovapd ymm2, [sobelr2]
   105                                 
   106 0000004D C5FD281C25[00000000]      vmovapd ymm3, [sobelr0_shr]
   107 00000056 C5FD282425[00000000]      vmovapd ymm4, [sobelr1_shr]
   108 0000005F C5FD282C25[00000000]      vmovapd ymm5, [sobelr2_shr]
   109                                 
   110                                  outer_loop:
   111                                 
   112 00000068 4D31C9                  xor r9, r9
   113                                 
   114                                  inner_loop:
   115                                 
   116                                 
   117                                 
   118                                 
   119                                 
   120                                 
   121 0000006B 4989FA                  mov r10, rdi
   122                                 
   123 0000006E C4C17D1032              vmovupd ymm6, [r10]
   124                                 
   125 00000073 4D8D540A10              lea r10, [r10 + 1*rcx + 16]
   126 00000078 C4C17D103A              vmovupd ymm7, [r10]
   127                                 
   128 0000007D 4D8D540A10              lea r10, [r10 + 1*rcx + 16]
   129 00000082 C4417D1002              vmovupd ymm8, [r10]
   130                                 
   131                                 
   132 00000087 C57D28CE                vmovapd ymm9, ymm6
   133 0000008B C57D28D7                vmovapd ymm10, ymm7
   134 0000008F C4417D28D8              vmovapd ymm11, ymm8
   135                                 
   136                                 
   137                                 
   138                                 
   139                                 
   140                                 
   141                                 
   142                                 
   143                                 
   144                                 
   145                                 
   146                                 
   147                                 
   148                                 
   149                                 
   150 00000094 C5CD593425[00000000]      vmulpd ymm6, [sobelr0]
   151 0000009D C5C5593C25[00000000]      vmulpd ymm7, [sobelr1]
   152 000000A6 C53D590425[00000000]      vmulpd ymm8, [sobelr2]
   153                                 
   154 000000AF C535590C25[00000000]      vmulpd ymm9, [sobelr0_shr]
   155 000000B8 C52D591425[00000000]      vmulpd ymm10, [sobelr1_shr]
   156 000000C1 C525591C25[00000000]      vmulpd ymm11, [sobelr2_shr]
   157                                 
   158 000000CA C53D58C6                vaddpd ymm8, ymm6
   159 000000CE C53D58C7                vaddpd ymm8, ymm7
   160                                 
   161 000000D2 C4412558D9              vaddpd ymm11, ymm9
   162 000000D7 C4412558DA              vaddpd ymm11, ymm10
   163                                 
   164                                 
   165                                 
   166                                 
   167                                 
   168 000000DC C4637D39C601            vextracti128 xmm6, ymm8, 1
   169 000000E2 C4437D39D901            vextracti128 xmm9, ymm11, 1
   170                                 
   171 000000E8 66440F58C6              addpd xmm8, xmm6
   172 000000ED 66450F58D9              addpd xmm11, xmm9
   173                                 
   174 000000F2 C4C3FD00F801            vpermq ymm7, ymm8, 0x01
   175 000000F8 C443FD00D301            vpermq ymm10, ymm11, 0x01
   176                                 
   177 000000FE F2440F58C7              addsd xmm8, xmm7
   178 00000103 F2450F58DA              addsd xmm11, xmm10
   179                                 
   180                                 
   181                                 
   182                                 
   183                                 
   184                                 
   185                                 
   186                                 
   187                                 
   188                                 
   189                                 
   190 00000108 F2440F1106              movsd [rsi], xmm8
   191 0000010D F2440F115E08            movsd [rsi+8], xmm11
   192                                 
   193 00000113 4883C710                add rdi, 16
   194 00000117 4883C610                add rsi, 16
   195                                 
   196                                 
   197 0000011B 4983C110                add r9, 16
   198 0000011F 4939C9                  cmp r9, rcx
   199 00000122 0F8C3DFFFFFF            jl inner_loop
   200                                 
   201                                 
   202 00000128 4883C710                add rdi, 16
   203 0000012C 4883C610                add rsi, 16
   204                                 
   205                                 
   206 00000130 49FFC0                  inc r8
   207 00000133 4C39C2                  cmp rdx, r8
   208 00000136 0F8526FFFFFF            jne outer_loop
   209                                 
   210                                  clean_and_return:
   211                                 
   212 0000013C 4883C448                add rsp, 72
   213 00000140 5D                      pop rbp
   214 00000141 48C7C001000000          mov rax, 1
   215 00000148 C3                      ret
   216                                 
   217                                 
   218                                  invalid_image_size:
   219                                 
   220                                 
   221                                 
   222 00000149 EBEF                    jmp clean_and_return
   223                                 
   224                                  print_pointer_subroutine:
   225 0000014B 55                      push rbp
   226 0000014C 4889E5                  mov rbp, rsp
   227 0000014F 4883EC50                sub rsp, 80
   228                                 
   229 00000153 48897C2408              mov [rsp+8], rdi
   230 00000158 4889742410              mov [rsp+16], rsi
   231 0000015D 4889542418              mov [rsp+24], rdx
   232 00000162 48894C2420              mov [rsp+32], rcx
   233 00000167 4C89442428              mov [rsp+40], r8
   234 0000016C 4C894C2430              mov [rsp+48], r9
   235 00000171 4C89542438              mov [rsp+56], r10
   236 00000176 4C895C2440              mov [rsp+64], r11
   237                                 
   238 0000017B 48C7C7[00000000]        mov rdi, print_pointer
   239 00000182 488B742408              mov rsi, [rsp+8]
   240 00000187 E8(F6FFFFFF)            call printf
   241                                 
   242 0000018C 488B7C2408              mov rdi, [rsp+8]
   243 00000191 488B742410              mov rsi, [rsp+16]
   244 00000196 488B542418              mov rdx, [rsp+24]
   245 0000019B 488B4C2420              mov rcx, [rsp+32]
   246 000001A0 4C8B442428              mov r8, [rsp+40]
   247 000001A5 4C8B4C2430              mov r9, [rsp+48]
   248 000001AA 4C8B542438              mov r10, [rsp+56]
   249 000001AF 4C8B5C2440              mov r11, [rsp+64]
   250                                 
   251 000001B4 4883C450                add rsp, 80
   252 000001B8 5D                      pop rbp
   253 000001B9 C3                      ret
