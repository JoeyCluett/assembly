     1                                 %line 1+1 main.asm
     2                                 
     3                                 
     4                                 
     5                                 
     6                                 
     7                                 [extern printf]
     8                                 [extern apply_gp_sobel]
     9                                 [extern apply_simd_sobel]
    10                                 [global sobel]
    11                                 
    12                                 [section .data]
    13                                 
    14 00000000 [0000000000000000]-     sobel_jump_lut: dq apply_gp_sobel, test_apply_simd
    15 00000000 [0000000000000000] 
    16                                 
    17 00000010 0000000000000000        normal_ret_val: dq 0x00000000
    18 00000018 0100000000000000        simd_no_support: dq 0x00000001
    19                                 
    20                                 [section .text]
    21                                 sobel:
    22 00000000 55                      push rbp
    23 00000001 4889E5                  mov rbp, rsp
    24                                 
    25                                 
    26                                 
    27                                 
    28                                 
    29                                 
    30                                 
    31                                 
    32                                 
    33                                 
    34                                 
    35 00000004 4983F802                cmp r8, 2
    36 00000008 7D09                    jge end_sobel
    37 0000000A 49C1E003                shl r8, 3
    38 0000000E 41FF90[00000000]        call [r8 + sobel_jump_lut]
    39                                 
    40                                  end_sobel:
    41 00000015 5D                      pop rbp
    42 00000016 C3                      ret
    43                                 
    44                                 
    45                                  test_apply_simd:
    46                                 
    47                                 
    48 00000017 55                      push rbp
    49 00000018 4889E5                  mov rbp, rsp
    50                                 
    51 0000001B 52                      push rdx
    52 0000001C 51                      push rcx
    53                                 
    54 0000001D B807000000              mov eax, 7
    55 00000022 B900000000              mov ecx, 0
    56 00000027 0FA2                    cpuid
    57                                 
    58 00000029 59                      pop rcx
    59 0000002A 5A                      pop rdx
    60                                 
    61                                 
    62                                 
    63 0000002B 83E310                  and ebx, DWORD 0x0010
    64 0000002E 83FB10                  cmp ebx, 0x0010
    65 00000031 7505                    jne use_gp_sobel
    66                                 
    67                                 
    68 00000033 E8(F6FFFFFF)            call apply_simd_sobel
    69                                 
    70 00000038 5D                      pop rbp
    71 00000039 C3                      ret
    72                                 
    73                                  use_gp_sobel:
    74                                 
    75 0000003A E8(F6FFFFFF)            call apply_gp_sobel
    76                                 
    77 0000003F 5D                      pop rbp
    78 00000040 C3                      ret
